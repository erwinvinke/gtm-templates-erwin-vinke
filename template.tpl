___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Squeezely CDP - Conversion API",
  "brand": {
    "id": "brand_dummy",
    "displayName": "gtm-templates-erwin-vinke",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDcuMS1jMDAwIDc5LmRhYmFjYmIsIDIwMjEvMDQvMTQtMDA6Mzk6NDQgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCAyMy4wIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0OTUyRUJBOEI5QzIxMUVFODM3Q0E2NjcyQTlCQkEwQSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo0OTUyRUJBOUI5QzIxMUVFODM3Q0E2NjcyQTlCQkEwQSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjQ5NTJFQkE2QjlDMjExRUU4MzdDQTY2NzJBOUJCQTBBIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjQ5NTJFQkE3QjlDMjExRUU4MzdDQTY2NzJBOUJCQTBBIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+aIaAHwAAGC9JREFUeNrs3Qd4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"
  },
  "description": "Unofficial Squeezely CDP tag template that sends the event data from the GA4 data client to the Squeezely conversion API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "squeezelyID",
    "displayName": "Squeezely ID",
    "simpleValueType": true,
    "help": "Find your Squeezely ID in the Settings section in Squeezely."
  },
  {
    "type": "TEXT",
    "name": "APIkey",
    "displayName": "API key",
    "simpleValueType": true,
    "help": "Find your Squeezely API key in the Settings section in Squeezely."
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "Event name",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "eventData",
    "displayName": "Event data",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "LABEL",
        "name": "customDataLabel",
        "displayName": "Standard parameters that you can send to Squeezely can be found in the \u003ca target\u003d\"_blank\" href\u003d\"https://app.squeezely.tech/documentation\"\u003eSqueezely API documentation\u003c/a\u003e.\n\nExamples: userid, email, products. Note: url will be sent automatically."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customDataList",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter name",
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "displayName": "debug",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Load the APIs
const encodeUriComponent = require('encodeUriComponent');
const decodeUriComponent = require('decodeUriComponent');
const getAllEventData = require('getAllEventData');
const JSON = require('JSON');
const log = require('logToConsole');
const sendHttpRequest = require('sendHttpRequest');
const getCookieValues = require('getCookieValues');
const getRequestHeader = require('getRequestHeader');
const logToConsole = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const eventData = getAllEventData();
const isLoggingEnabled = determinateIsLoggingEnabled();
const event = {};

function enc(data) {
  data = data || '';
  return encodeUriComponent(data);
}

// Define endpoint
const apiEndpoint = "https://api.squeezely.tech/v1/track";
const apiToken = enc(data.APIkey);
const squeezelyId = enc(data.squeezelyID);

function mapData(){
  // Event data
  const url = eventData.page_location || getRequestHeader('referer');
  const cookie = getCookieValues('sqzllocal')[0];

  // Build event data model
  event.sqzly_cookie = cookie;
  event.url = url;
  event.event = data.eventName;
  
  // check for custom data
  if (data.customDataList) {
    data.customDataList.forEach((d) => {
      event[d.name] = d.value;
    });
  }
}

mapData();

const postBody = {
  data: event,
  partner_agent: 'erwin-vinke'
};

const requestHeaders = {
  headers: {
    'content-type': 'application/json', 
    'X-AUTH-ACCOUNT': squeezelyId,
    'X-AUTH-APIKEY': apiToken
  }, 
  method: 'POST'
};

// Send the request in the expected format, log a successful response
sendHttpRequest(
  apiEndpoint,
  (statusCode, headers, response) => {
    // Log to console if enabled
    if (isLoggingEnabled) {
      logToConsole(
        JSON.stringify({
          Name: 'Squeezely',
          Type: 'Response',
          EventName: data.eventName,
          ResponseStatusCode: statusCode,
          ResponseHeaders: headers,
          ResponseBody: response,
        })
      );
    }
    if (statusCode >= 200 && statusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  },
  requestHeaders,
  JSON.stringify(event));

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.squeezely.tech/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "sqzllocal"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 23-1-2024 14:00:21


